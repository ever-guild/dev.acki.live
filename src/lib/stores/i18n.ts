import { writable, derived } from 'svelte/store';
import { browser } from '$app/environment';

export type Language = 'en' | 'ru';

interface Translations {
  [key: string]: {
    [key: string]: string;
  };
}

const translations: Translations = {
  en: {
    'navbar.closeOverlay': 'Close',
    'navbar.closeMenu': 'Close menu',
    'transactions.pageTitle': 'Transaction',
    'transactions.details.back': 'Back to Transactions',
    'transactions.details.title': 'Transaction Details',
    'transactions.details.loadErrorTitle': 'Failed to load transaction',
    'transactions.details.overview': 'Overview',
    'transactions.details.txId': 'Transaction ID',
    'transactions.details.status': 'Status',
    'transactions.details.accountAddress': 'Account Address',
    'transactions.details.timestamp': 'Timestamp',
    'transactions.details.balanceDelta': 'Balance Delta',
    'transactions.details.totalFees': 'Total Fees',
    'transactions.details.type': 'Transaction Type',
    'transactions.details.workchainId': 'Workchain ID',
    'transactions.details.computePhase': 'Compute Phase',
    'transactions.details.compute.success': 'Success',
    'transactions.details.compute.exitCode': 'Exit Code',
    'transactions.details.compute.gasUsed': 'Gas Used',
    'transactions.details.compute.gasFees': 'Gas Fees',
    'transactions.details.inputMsg': 'Input Message',
    'transactions.details.outputMsgs': 'Output Messages',
    'transactions.details.from': '@:common.from',
    'transactions.details.to': '@:common.to',
    'transactions.details.value': '@:common.value',
    'app.title': 'Blockchain Explorer',
    'app.loading': 'Loading...',
    'transactions.loadErrorTitle': 'Failed to load transactions',
    'showcase.loadErrorTitle': 'Failed to load showcase data',
    'showcase.networkHealth': 'Network Health',
    'showcase.recentActivity': 'Recent Activity',
    'showcase.topActiveAccounts': 'Top Active Accounts',
    'showcase.blockProductionRate': 'Block Production Rate (Last 12 Hours)',
    'showcase.messageTypeDistribution': 'Message Type Distribution',
    'showcase.loadingAccountData': 'Loading account data...',
    'showcase.loadingMessageData': 'Loading message data...',
    'error.defaultTitle': 'Failed to load',
    'error.retry': 'Retry',
    'stats.loadErrorTitle': 'Failed to load statistics',
    'stats.networkOverview': 'Network Overview',
    'stats.mock': 'Mock',
    'copy.copied': 'Copied',
    'navbar.searchPlaceholder': 'name / address / msg / tx / block',
    'navbar.noResults': 'No results found',
    'navbar.toggleMenu': 'Toggle menu',
    'navbar.toggleTheme': 'Toggle theme',
    'nav.blocks': 'Blocks',
    'nav.transactions': 'Transactions',
    'nav.messages': 'Messages',
    'nav.contracts': 'Contracts',
    'nav.stats': 'Statistics',
    'nav.showcase': 'Showcase',
    'blocks.title': 'Recent Blocks',
    'blocks.height': 'Height',
    'blocks.hash': 'Hash',
    'blocks.timestamp': 'Timestamp',
    'blocks.txCount': 'Transactions',
    'blocks.miner': 'Miner',
    'transactions.title': 'Recent Transactions',
    'transactions.hash': 'Tx Hash',
    'transactions.from': '@:common.from',
    'transactions.to': '@:common.to',
    'transactions.amount': '@:common.amount',
    'transactions.status': '@:common.status',
    'transactions.time': '@:common.time',
    'messages.title': 'Blockchain Messages',
    'messages.from': '@:common.from',
    'messages.to': '@:common.to',
    'messages.type': '@:common.type',
    'messages.timestamp': '@:common.time',
    'messages.data': '@:common.data',
    'contracts.title': 'Smart Contracts',
    'contracts.headers.name': 'Name',
    'contracts.headers.address': 'Address',
    'contracts.headers.description': 'Description',
    'contracts.headers.type': 'Type',
    'contracts.type.system': 'System',
    'contracts.address': '@:common.address',
    'contracts.created': 'Created',
    'contracts.interactions': 'Interactions',
    'contracts.creator': 'Creator',
    'contracts.type': 'Type',
    'stats.title': 'Network Statistics',
    'stats.totalBlocks': 'Total Blocks',
    'stats.totalTransactions': 'Total Transactions',
    'stats.hashrate': 'Network Hashrate',
    'stats.activeAddresses': 'Active Addresses',
    'stats.avgBlockTime': 'Avg Block Time',
    'stats.difficulty': 'Difficulty',
    'stats.marketCap': 'Market Cap',
    'stats.price': 'Price',
    'showcase.title': 'Blockchain Showcase',
    // Showcase stat labels
    'showcase.stat.blockProduction': 'Block Production',
    'showcase.stat.transactionThroughput': 'Transaction Throughput',
    'showcase.stat.networkLatency': 'Network Latency',
    'showcase.stat.normal': 'Normal',
    'showcase.stat.high': 'High',
    'showcase.stat.low': 'Low',
    'status.success': '@:common.success',
    'status.pending': '@:common.pending',

    // Common words
    'common.from': 'From',
    'common.to': 'To',
    'common.value': 'Value',
    'common.status': 'Status',
    'common.type': 'Type',
    'common.time': 'Time',
    'common.amount': 'Amount',
    'common.address': 'Address',
    'common.data': 'Data',
    'common.success': 'Success',
    'common.failed': 'Failed',
    'common.pending': 'Pending',

    // Account page translations
    'account.title': 'Account',
    'account.type': 'Type',
    'account.address': 'Address',
    'account.balance': 'Balance',
    'account.lastPaid': 'Last Paid',
    'account.linkedAccounts': 'Linked Accounts',
    'account.linked.none': 'No linked accounts',
    'account.recentTransactions': 'Recent Transactions',
    'account.noTransactions': 'No transactions found for this account',
    'account.txId': 'Transaction ID',
    'account.status': 'Status',
    'account.balanceChange': 'Balance Change',
    'account.fees': 'Fees',
    'account.time': 'Time',
    'account.aborted': 'Aborted',
    'account.codeData': 'Code & Data',
    'account.codeHash': 'Code Hash',
    'account.dataHash': 'Data Hash',
    'account.initCodeHash': 'Init Code Hash',
    'account.code': 'Code',
    'account.lastTransLt': 'Last Transaction LT',
    'account.bits': 'Bits',
    'account.cells': 'Cells',
    'account.publicCells': 'Public Cells',
    'account.data': 'Data',
    'account.name': 'Name',
    'status.failed': 'Failed'
  },
  ru: {
    'navbar.closeOverlay': 'Закрыть',
    'navbar.closeMenu': 'Закрыть меню',
    'transactions.pageTitle': 'Транзакция',
    'transactions.details.back': 'Назад к транзакциям',
    'transactions.details.title': 'Детали транзакции',
    'transactions.details.loadErrorTitle': 'Не удалось загрузить транзакцию',
    'transactions.details.overview': 'Обзор',
    'transactions.details.txId': 'ID транзакции',
    'transactions.details.status': 'Статус',
    'transactions.details.accountAddress': 'Адрес аккаунта',
    'transactions.details.timestamp': 'Время',
    'transactions.details.balanceDelta': 'Изменение баланса',
    'transactions.details.totalFees': 'Комиссии',
    'transactions.details.type': 'Тип транзакции',
    'transactions.details.workchainId': 'Workchain ID',
    'transactions.details.computePhase': 'Фаза вычисления',
    'transactions.details.compute.success': 'Успех',
    'transactions.details.compute.exitCode': 'Код выхода',
    'transactions.details.compute.gasUsed': 'Использовано газа',
    'transactions.details.compute.gasFees': 'Комиссии за газ',
    'transactions.details.inputMsg': 'Входящее сообщение',
    'transactions.details.outputMsgs': 'Исходящие сообщения',
    'transactions.details.from': '@:common.from',
    'transactions.details.to': '@:common.to',
    'transactions.details.value': '@:common.value',
    'app.title': 'Блокчейн-обозреватель',
    'app.loading': 'Загрузка...',
    'transactions.loadErrorTitle': 'Не удалось загрузить транзакции',
    'showcase.loadErrorTitle': 'Не удалось загрузить данные витрины',
    'showcase.networkHealth': 'Здоровье сети',
    'showcase.recentActivity': 'Последняя активность',
    'showcase.topActiveAccounts': 'Топ активных аккаунтов',
    'showcase.blockProductionRate': 'Производство блоков (последние 12 часов)',
    'showcase.messageTypeDistribution': 'Распределение типов сообщений',
    'showcase.loadingAccountData': 'Загрузка данных аккаунтов...',
    'showcase.loadingMessageData': 'Загрузка данных сообщений...',
    'error.defaultTitle': 'Не удалось загрузить',
    'error.retry': 'Повторить',
    'stats.loadErrorTitle': 'Не удалось загрузить статистику',
    'stats.networkOverview': 'Обзор сети',
    'stats.mock': 'Тестовые данные',
    'copy.copied': 'Скопировано',
    'navbar.searchPlaceholder': 'имя / адрес / сообщение / tx / блок',
    'navbar.noResults': 'Результатов не найдено',
    'navbar.toggleMenu': 'Показать меню',
    'navbar.toggleTheme': 'Переключить тему',
    'nav.blocks': 'Блоки',
    'nav.transactions': 'Транзакции',
    'nav.messages': 'Сообщения',
    'nav.contracts': 'Контракты',
    'nav.stats': 'Статистика',
    'nav.showcase': 'Витрина',
    'blocks.title': 'Последние блоки',
    'blocks.height': 'Высота',
    'blocks.hash': 'Хэш',
    'blocks.timestamp': 'Время',
    'blocks.txCount': 'Транзакций',
    'blocks.miner': 'Майнер',
    'transactions.title': 'Последние транзакции',
    'transactions.hash': 'Хэш транзакции',
    'transactions.from': '@:common.from',
    'transactions.to': '@:common.to',
    'transactions.amount': '@:common.amount',
    'transactions.status': '@:common.status',
    'transactions.time': '@:common.time',
    'messages.title': 'Сообщения блокчейна',
    'messages.from': '@:common.from',
    'messages.to': '@:common.to',
    'messages.type': '@:common.type',
    'messages.timestamp': '@:common.time',
    'messages.data': '@:common.data',
    'contracts.title': 'Смарт-контракты',
    'contracts.headers.name': 'Имя',
    'contracts.headers.address': 'Адрес',
    'contracts.headers.description': 'Описание',
    'contracts.headers.type': 'Тип',
    'contracts.type.system': 'Система',
    'contracts.address': '@:common.address',
    'contracts.created': 'Создан',
    'contracts.interactions': 'Взаимодействий',
    'contracts.creator': 'Создатель',
    'contracts.type': 'Тип',
    'stats.title': 'Статистика сети',
    'stats.totalBlocks': 'Всего блоков',
    'stats.totalTransactions': 'Всего транзакций',
    'stats.hashrate': 'Хэшрейт сети',
    'stats.activeAddresses': 'Активных адресов',
    'stats.avgBlockTime': 'Среднее время блока',
    'stats.difficulty': 'Сложность',
    'stats.marketCap': 'Рыночная капитализация',
    'stats.price': 'Цена',
    'showcase.title': 'Витрина блокчейна',
    // Showcase stat labels
    'showcase.stat.blockProduction': 'Производство блоков',
    'showcase.stat.transactionThroughput': 'Пропускная способность транзакций',
    'showcase.stat.networkLatency': 'Задержка сети',
    'showcase.stat.normal': 'Нормально',
    'showcase.stat.high': 'Высокая',
    'showcase.stat.low': 'Низкая',
    'status.success': '@:common.success',
    'status.pending': '@:common.pending',

    // Common words
    'common.from': 'От',
    'common.to': 'Кому',
    'common.value': 'Значение',
    'common.status': 'Статус',
    'common.type': 'Тип',
    'common.time': 'Время',
    'common.amount': 'Сумма',
    'common.address': 'Адрес',
    'common.data': 'Данные',
    'common.success': 'Успешно',
    'common.failed': 'Неудачно',
    'common.pending': 'В ожидании',

    // Account page translations
    'account.title': 'Аккаунт',
    'account.type': 'Тип',
    'account.address': 'Адрес',
    'account.balance': 'Баланс',
    'account.lastPaid': 'Последняя выплата',
    'account.name': 'Имя',
    'account.linkedAccounts': 'Связанные аккаунты',
    'account.linked.none': 'Связанных аккаунтов нет',
    'account.recentTransactions': 'Последние транзакции',
    'account.noTransactions': 'Транзакции для этого аккаунта не найдены',
    'account.txId': 'ID транзакции',
    'account.status': 'Статус',
    'account.balanceChange': 'Изменение баланса',
    'account.fees': 'Комиссии',
    'account.time': 'Время',
    'account.aborted': 'Прервано',
    'account.codeData': 'Код и данные',
    'account.codeHash': 'Хэш кода',
    'account.dataHash': 'Хэш данных',
    'account.initCodeHash': 'Хэш init-кода',
    'account.code': 'Код',
    'account.lastTransLt': 'LT последней транзакции',
    'account.bits': 'Биты',
    'account.cells': 'Ячейки',
    'account.publicCells': 'Публичные ячейки',
    'account.data': 'Данные',
    'status.failed': 'Неудачно'
  }
};

function createI18nStore() {
  const savedLang = browser ? (localStorage.getItem('language') as Language) || 'en' : 'en';
  const { subscribe, set } = writable<Language>(savedLang);

  return {
    subscribe,
    setLanguage: (lang: Language) => {
      if (browser) {
        localStorage.setItem('language', lang);
      }
      set(lang);
    }
  };
}

export const currentLanguage = createI18nStore();

export const translate = derived(currentLanguage, ($lang) => {
  function resolve(key: string, seen = new Set<string>()): string {
    if (seen.has(key)) return key; // avoid cycles
    seen.add(key);
    const val = translations[$lang][key];
    if (!val) return key;
    // support aliasing with '@:other.key'
    if (val.startsWith('@:')) {
      const target = val.slice(2);
      return resolve(target, seen);
    }
    return val;
  }

  return (key: string): string => {
    return resolve(key);
  };
});
